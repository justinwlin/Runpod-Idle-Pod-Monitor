{% extends "base.html" %}

{% block title %}Billing Reports - RunPod Monitor{% endblock %}

{% block header %}ðŸ’° Billing Reports{% endblock %}

{% block content %}
<div x-data="reportsApp()">
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2">Known Cost</h6>
                    <h3 class="card-title" x-text="'$' + summary.known_cost_total.toFixed(2)">$0.00</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2">Total Hours</h6>
                    <h3 class="card-title" x-text="summary.total_hours.toFixed(2)">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2">Known Cost Pods</h6>
                    <h3 class="card-title" x-text="summary.known_cost_pods">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2">Total Pods</h6>
                    <h3 class="card-title" x-text="summary.total_pods">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading billing data...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" class="alert alert-danger" role="alert">
        <strong>Error:</strong> <span x-text="error"></span>
    </div>

    <!-- API Info -->
    <div class="alert alert-info" role="alert">
        <strong>ðŸ“¡ API Endpoint (Audit-Based Billing):</strong>
        <code id="api-endpoint" style="background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px;">
            <span x-text="window.location.origin + '/api/reports/billing-json-audit'"></span>
        </code>
        <button class="btn btn-sm btn-outline-secondary ms-2" @click="copyEndpoint()" title="Copy to clipboard">
            <i class="fas fa-copy"></i>
        </button>
        <small class="d-block mt-2 text-muted">
            Audit-based billing from pod lifecycle events - accurate runtime tracking
        </small>
    </div>

    <!-- Pods Table -->
    <div x-show="!loading && !error && known_cost_pods.length > 0" class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ðŸ“Š Pod Billing</h5>
            <div>
                <button
                    class="btn btn-sm btn-primary"
                    @click="loadData()"
                    :disabled="loading"
                >
                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i>
                    <span x-text="loading ? 'Refreshing...' : 'Refresh'"></span>
                </button>
                <button class="btn btn-sm btn-success ms-2" @click="downloadCSV()">
                    <i class="fas fa-download"></i> Download CSV
                </button>
                <button class="btn btn-sm btn-info ms-2" @click="downloadJSON()">
                    <i class="fas fa-code"></i> Download JSON
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover pod-table">
                    <thead>
                        <tr>
                            <th>Pod Name</th>
                            <th>Status</th>
                            <th>Cost/hr</th>
                            <th>Active Hours</th>
                            <th>Total Cost</th>
                            <th>Sessions</th>
                            <th>Cost Calculation Method</th>
                            <th>Calculation Details</th>
                            <th>Created At</th>
                            <th>Created By</th>
                            <th>Terminated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="pod in known_cost_pods" :key="pod.pod_id">
                            <tr :class="{ 'table-warning': !pod.cost_known }">
                                <!-- Pod Name -->
                                <td>
                                    <div class="pod-name" x-text="pod.pod_name"></div>
                                    <small class="pod-id" x-text="pod.pod_id.substring(0, 8) + '...'"></small>
                                </td>

                                <!-- Status -->
                                <td>
                                    <span
                                        class="status-badge"
                                        :class="{
                                            'badge bg-success': pod.status === 'RUNNING',
                                            'badge bg-danger': pod.status === 'TERMINATED',
                                            'badge bg-secondary': !['RUNNING', 'TERMINATED'].includes(pod.status)
                                        }"
                                        x-text="pod.status"
                                    ></span>
                                </td>

                                <!-- Cost per hour -->
                                <td class="cost-display">
                                    <span x-text="pod.cost_per_hr_display"></span>
                                    <span x-show="!pod.cost_known" class="badge bg-warning ms-1" title="Cost unknown - pod predates monitoring">âš </span>
                                </td>

                                <!-- Active Hours (from audit logs) -->
                                <td class="uptime-display" x-text="pod.active_hours.toFixed(2)"></td>

                                <!-- Total Cost (from audit logs) -->
                                <td>
                                    <strong class="cost-display" x-text="pod.total_cost_display"></strong>
                                </td>

                                <!-- Sessions -->
                                <td>
                                    <span class="badge bg-info" x-text="pod.sessions"></span>
                                </td>

                                <!-- Cost Calculation Method -->
                                <td>
                                    <small x-text="pod.billing_method === 'metrics_tracked' ? 'Metrics Tracked' : (pod.billing_method === 'created_time' ? 'createdAt' : 'Unknown')"></small>
                                </td>

                                <!-- Calculation Details -->
                                <td>
                                    <small style="max-width: 400px; display: block; word-wrap: break-word;" x-text="pod.billing_note"></small>
                                </td>

                                <!-- Created At -->
                                <td>
                                    <small x-text="pod.created_at || 'N/A'"></small>
                                </td>

                                <!-- Created By -->
                                <td>
                                    <small x-text="pod.created_by || 'N/A'"></small>
                                </td>

                                <!-- Terminated At -->
                                <td>
                                    <small x-text="pod.terminated_at"></small>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- Empty State -->
    <div x-show="known_cost_pods.length === 0 && !loading" class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No billing data available yet. Start monitoring some pods!</p>
    </div>
</div>

<script>
function reportsApp() {
    return {
        loading: true,
        error: null,
        known_cost_pods: [],
        unknown_cost_pods: [],
        summary: {
            known_cost_total: 0,
            total_hours: 0,
            known_cost_pods: 0,
            unknown_cost_pods: 0,
            total_pods: 0
        },

        async init() {
            console.log('Reports app initialized');
            await this.loadData();
        },

        async loadData() {
            this.loading = true;
            this.error = null;

            try {
                const response = await fetch('/api/reports/billing-audit');
                const data = await response.json();

                if (data.error) {
                    this.error = data.error;
                } else {
                    this.known_cost_pods = data.known_cost_pods || [];
                    this.unknown_cost_pods = data.unknown_cost_pods || [];
                    this.summary = data.summary || this.summary;
                }
            } catch (err) {
                console.error('Error loading billing data:', err);
                this.error = 'Failed to load billing data: ' + err.message;
            } finally {
                this.loading = false;
            }
        },

        downloadCSV() {
            console.log('Downloading CSV...');
            // Open audit-based download endpoint
            window.open('/api/reports/download-csv-audit', '_blank');
        },

        downloadJSON() {
            console.log('Downloading JSON...');
            // Open audit-based JSON endpoint
            window.open('/api/reports/billing-json-audit', '_blank');
        },

        copyEndpoint() {
            const endpoint = window.location.origin + '/api/reports/billing-json-audit';
            navigator.clipboard.writeText(endpoint).then(() => {
                console.log('Endpoint copied to clipboard!');
                // Optional: Show a temporary success message
                alert('API endpoint copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
    };
}
</script>
{% endblock %}
